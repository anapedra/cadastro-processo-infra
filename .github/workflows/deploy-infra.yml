name: Infra + Backend Deploy

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  BUCKET_TEMPLATES: asantanadev-cfn-templates

jobs:
# =========================================
# FUNDACAO (VPC + SG + RDS)
# =========================================
  fundacao:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/fundacao s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy fundacao
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-fundacao-prod \
            --template-file infra/templates/modulos/fundacao/master-fundacao.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              ProjetoNome=${{ vars.STACK_NAME }} \
              VpcCIDR=10.0.0.0/16 \
              DBName=cadastros_usuario

# =========================================
# APLICACAO (ALB + ASG + HTTPS) - CORRIGIDO
# =========================================
  aplicacao:
    needs: fundacao
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/aplicacao s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy aplicacao
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-aplicacao-prod \
            --template-file infra/templates/modulos/aplicacao/master-aplicacao.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              ProjetoNome=${{ vars.STACK_NAME }} \
              FundacaoStack=cadastro-fundacao-prod \
              CertificateArn=${{ vars.CERTIFICATE_ARN }}

# =========================================
# BACKEND (build jar + upload S3)
# =========================================
  backend:
    needs: aplicacao
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Spring Boot
        run: |
          cd back/cadastros-usuario
          ./mvnw clean package -DskipTests

      - name: Upload jar to S3
        run: |
          aws s3 cp back/cadastros-usuario/target/*.jar s3://${{ env.BUCKET_TEMPLATES }}/app.jar

# =========================================
# ENTREGA (frontend infra)
# =========================================
  entrega:
    needs: backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/entrega s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy entrega
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-entrega-prod \
            --template-file infra/templates/modulos/entrega/master-entrega.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              ProjetoNome=${{ vars.STACK_NAME }}

# =========================================
# DNS (Route53)
# =========================================
  dns:
    needs: entrega
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy DNS
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-dns-prod \
            --template-file infra/templates/modulos/dns/route53.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              ProjetoNome=${{ vars.STACK_NAME }} \
              HostedZoneId=${{ vars.HOSTED_ZONE_ID }}