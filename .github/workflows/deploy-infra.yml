name: Infra + Backend Deploy Professional

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  BUCKET_TEMPLATES: asantanadev-cfn-templates

jobs:
# =========================================
# 1. FUNDACAO (VPC + SG + RDS com Secrets)
# =========================================
  fundacao:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy fundacao
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-fundacao-prod \
            --template-file infra/templates/modulos/fundacao/master-fundacao.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides ProjetoNome=${{ vars.STACK_NAME }}

# =========================================
# 2. APLICACAO (ALB + ASG)
# =========================================
  aplicacao:
    needs: fundacao
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy aplicacao
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-aplicacao-prod \
            --template-file infra/templates/modulos/aplicacao/master-aplicacao.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              ProjetoNome=${{ vars.STACK_NAME }} \
              FundacaoStack=cadastro-fundacao-prod \
              CertificateArn=${{ vars.CERTIFICATE_ARN }}

# =========================================
# 3. BACKEND (Build Real e Upload corrigido)
# =========================================
  backend:
    needs: aplicacao
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: 'maven'

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Spring Boot
        run: |
          cd back/cadastros-usuario
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Upload jar to S3
        run: |
          # Corrigido para capturar o arquivo exato e renomear para app.jar no S3
          aws s3 cp back/cadastros-usuario/target/cadastros-usuario-*.jar s3://${{ env.BUCKET_TEMPLATES }}/app.jar

# =========================================
# 4. ENTREGA (CloudFront/S3 Frontend)
# =========================================
  entrega:
    needs: backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Deploy entrega
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-entrega-prod \
            --template-file infra/templates/modulos/entrega/master-entrega.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides ProjetoNome=${{ vars.STACK_NAME }}

# =========================================
# 5. DNS (Route53)
# =========================================
  dns:
    needs: entrega
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Deploy DNS
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-dns-prod \
            --template-file infra/templates/modulos/dns/route53.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              ProjetoNome=${{ vars.STACK_NAME }} \
              HostedZoneId=${{ vars.HOSTED_ZONE_ID }}