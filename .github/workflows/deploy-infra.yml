name: Infra + Backend Deploy

on:
  push:
    branches: [ "main" ]

# =====================================================
# OIDC PERMISSIONS (REMOVE access keys estáticas)
# Necessário para autenticação segura com AWS via Role
# =====================================================
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  BUCKET_TEMPLATES: asantanadev-cfn-templates

jobs:

# =========================================
# FUNDACAO (VPC + SG + RDS)
# =========================================
  fundacao:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # =========================================
      # CORRIGIDO: OIDC (remove AWS_ACCESS_KEY/SECRET)
      # =========================================
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/fundacao s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy fundacao
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-fundacao-dev \
            --template-file infra/templates/modulos/fundacao/master-fundacao.yaml \
            --parameter-overrides file://infra/templates/modulos/fundacao/environments-fundacao/dev/parametros-dev.json \
            --capabilities CAPABILITY_NAMED_IAM


# =========================================
# APLICACAO (ALB + ASG + HTTPS)
# =========================================
  aplicacao:
    needs: fundacao
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # =========================================
      # OIDC
      # =========================================
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/aplicacao s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      # =========================================
      # NOVO: passa CertificateArn para o ALB HTTPS
      # =========================================
      - name: Deploy aplicacao
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-aplicacao-dev \
            --template-file infra/templates/modulos/aplicacao/master-aplicacao.yaml \
            --parameter-overrides \
              file://infra/templates/modulos/aplicacao/environments-aplicacao/dev/parametros-dev.json \
              CertificateArn=${{ vars.CERTIFICATE_ARN }} \
            --capabilities CAPABILITY_NAMED_IAM


# =========================================
# BACKEND (build jar + upload S3)
# =========================================
  backend:
    needs: aplicacao
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # =========================================
      # OIDC
      # =========================================
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Spring Boot
        run: |
          cd back/cadastros-usuario
          ./mvnw clean package -DskipTests

      - name: Upload jar to S3
        run: |
          aws s3 cp back/cadastros-usuario/target/*.jar s3://${{ env.BUCKET_TEMPLATES }}/app.jar


# =========================================
# ENTREGA (frontend infra)
# =========================================
  entrega:
    needs: backend
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # =========================================
      # OIDC
      # =========================================
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/entrega s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy entrega
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-entrega-dev \
            --template-file infra/templates/modulos/entrega/master-entrega.yaml \
            --parameter-overrides file://infra/templates/modulos/entrega/environments-entrega/dev/parametros-dev.json \
            --capabilities CAPABILITY_NAMED_IAM


# =========================================
# DNS (Route53)
# =========================================
  dns:
    needs: entrega
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # =========================================
      # OIDC
      # =========================================
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy DNS
        run: |
          aws cloudformation deploy \
            --stack-name cadastro-dns-dev \
            --template-file infra/templates/modulos/dns/route53.yaml \
            --parameter-overrides \
              file://infra/templates/modulos/dns/environments-dns/dev/parametros-dev.json \
              HostedZoneId=${{ vars.HOSTED_ZONE_ID }}
