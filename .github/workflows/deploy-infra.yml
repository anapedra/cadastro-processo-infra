name: Infra + Backend Deploy

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  BUCKET_TEMPLATES: asantanadev-cfn-templates

jobs:

# =========================================
# FUNDACAO (VPC + SG + RDS)
# =========================================
  fundacao:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/fundacao s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy fundacao (JSON -> Key=Value)
        shell: bash
        run: |
          set -euo pipefail
          PARAMS="$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' infra/templates/modulos/fundacao/environments-fundacao/prod/parametros-prod.json | xargs)"
          aws cloudformation deploy \
            --stack-name cadastro-fundacao-prod \
            --template-file infra/templates/modulos/fundacao/master-fundacao.yaml \
            --parameter-overrides $PARAMS \
            --capabilities CAPABILITY_NAMED_IAM


# =========================================
# APLICACAO (ALB + ASG + HTTPS)
# =========================================
  aplicacao:
    needs: fundacao
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/aplicacao s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy aplicacao (JSON -> Key=Value + CertificateArn)
        shell: bash
        run: |
          set -euo pipefail
          PARAMS="$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' infra/templates/modulos/aplicacao/environments-aplicacao/prod/parametros-prod.json | xargs)"
          aws cloudformation deploy \
            --stack-name cadastro-aplicacao-prod \
            --template-file infra/templates/modulos/aplicacao/master-aplicacao.yaml \
            --parameter-overrides $PARAMS CertificateArn=${{ vars.CERTIFICATE_ARN }} \
            --capabilities CAPABILITY_NAMED_IAM


# =========================================
# BACKEND (build jar + upload S3)
# =========================================
  backend:
    needs: aplicacao
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build Spring Boot
        run: |
          cd back/cadastros-usuario
          ./mvnw clean package -DskipTests

      - name: Upload jar to S3
        run: |
          aws s3 cp back/cadastros-usuario/target/*.jar s3://${{ env.BUCKET_TEMPLATES }}/app.jar


# =========================================
# ENTREGA (frontend infra)
# =========================================
  entrega:
    needs: backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload templates
        run: |
          aws s3 cp infra/templates/modulos/entrega s3://${{ env.BUCKET_TEMPLATES }}/ --recursive --exclude "environments-*/*"

      - name: Deploy entrega (JSON -> Key=Value)
        shell: bash
        run: |
          set -euo pipefail
          PARAMS="$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' infra/templates/modulos/entrega/environments-entrega/prod/parametros-prod.json | xargs)"
          aws cloudformation deploy \
            --stack-name cadastro-entrega-prod \
            --template-file infra/templates/modulos/entrega/master-entrega.yaml \
            --parameter-overrides $PARAMS \
            --capabilities CAPABILITY_NAMED_IAM


# =========================================
# DNS (Route53)
# =========================================
  dns:
    needs: entrega
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy DNS (JSON -> Key=Value + HostedZoneId)
        shell: bash
        run: |
          set -euo pipefail
          PARAMS="$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' infra/templates/modulos/dns/environments-dns/prod/parametros-prod.json | xargs)"
          aws cloudformation deploy \
            --stack-name cadastro-dns-prod \
            --template-file infra/templates/modulos/dns/route53.yaml \
            --parameter-overrides $PARAMS HostedZoneId=${{ vars.HOSTED_ZONE_ID }} \
            --capabilities CAPABILITY_NAMED_IAM
