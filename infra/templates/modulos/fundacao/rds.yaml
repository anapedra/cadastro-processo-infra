AWSTemplateFormatVersion: '2010-09-09'
Description: RDS PostgreSQL v16.8 - Segurança Máxima com Referência Dinâmica SSM.

Parameters:
  ProjetoNome:
    Type: String
  VpcId:
    Type: AWS::EC2::VPC::Id
  PrivateSubnets:
    Type: List<AWS::EC2::Subnet::Id>
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup::Id
  DBName:
    Type: String
  DBInstanceClass:
    Type: String
    Default: db.t3.micro

  # Caminhos dos parâmetros no SSM Parameter Store
  DBUserSSM:
    Type: String
    Default: /cadastro/prod/db/user
  DBPasswordSSM:
    Type: String
    Default: /cadastro/prod/db/password

Resources:
  # =========================================================
  # Subnet Group do RDS (somente subnets privadas)
  # =========================================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: !Sub "Subnets privadas para o banco ${ProjetoNome}"
      SubnetIds: !Ref PrivateSubnets
      Tags:
        - Key: Name
          Value: !Sub "${ProjetoNome}-db-subnet-group"

  # =========================================================
  # Instância RDS PostgreSQL com Dynamic Reference
  # =========================================================
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: !Ref DBName
      Engine: postgres
      EngineVersion: "16.8"

      # REFERÊNCIA DINÂMICA: Busca os valores reais no SSM durante o deploy
      MasterUsername: !Sub '{{resolve:ssm-secure:${DBUserSSM}}}'
      MasterUserPassword: !Sub '{{resolve:ssm-secure:${DBPasswordSSM}}}'

      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: 20
      StorageType: gp3
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref DBSecurityGroup

      PubliclyAccessible: false
      BackupRetentionPeriod: 7
      DeleteAutomatedBackups: false

      Tags:
        - Key: Name
          Value: !Sub "${ProjetoNome}-database"

Outputs:
  Endpoint:
    Description: Host do banco para a variável DB_URL do Spring Boot
    Value: !GetAtt RDSInstance.Endpoint.Address
