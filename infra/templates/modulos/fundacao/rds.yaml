AWSTemplateFormatVersion: '2010-09-09'
Description: RDS PostgreSQL v16.8 - Segurança Máxima e Rede Fluida.

Parameters:
  ProjetoNome:
    Type: String

  VpcId:
    Type: AWS::EC2::VPC::Id

  PrivateSubnets:
    Type: List<AWS::EC2::Subnet::Id>

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup::Id

  DBName:
    Type: String

  DBInstanceClass:
    Type: String
    Default: db.t3.micro

Resources:
  # =========================================================
  # Subnet Group do RDS (somente subnets privadas)
  # =========================================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: !Sub "Subnets privadas para o banco ${ProjetoNome}"
      SubnetIds: !Ref PrivateSubnets
      Tags:
        - Key: Name
          Value: !Sub "${ProjetoNome}-db-subnet-group"

  # =========================================================
  # Instância RDS PostgreSQL
  # Credenciais NÃO vêm de Parameters (proibido pelo CFN)
  # =========================================================
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: !Ref DBName
      Engine: postgres
      EngineVersion: "16.8"

      # Credencial inicial apenas para criação do banco
      MasterUsername: cadastro_admin
      MasterUserPassword: InitialStrongPassword123!

      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: 20
      StorageType: gp3

      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref DBSecurityGroup

      PubliclyAccessible: false
      BackupRetentionPeriod: 7
      DeleteAutomatedBackups: false

      Tags:
        - Key: Name
          Value: !Sub "${ProjetoNome}-database"

Outputs:
  Endpoint:
    Description: Host do banco para a variável DB_URL do Spring Boot
    Value: !GetAtt RDSInstance.Endpoint.Address
